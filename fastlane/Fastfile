# fastlane/Fastfile
opt_out_usage

default_platform(:mac)

platform :mac do
  desc "Develop ë¸Œëœì¹˜: ë¹Œë“œ + í…ŒìŠ¤íŠ¸ + TestFlight ë°°í¬"
  lane :develop_deploy do
    UI.message "ğŸš€ Develop ë¸Œëœì¹˜ ë°°í¬ ì‹œì‘..."
    
    # 1. í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    UI.message "ğŸ“‹ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
    run_tests(
      scheme: "CaptionMate",
      device: "Any Mac"
    )
    
    # 2. ì¸ì¦ì„œ ë° í”„ë¡œë¹„ì €ë‹ í”„ë¡œí•„ ìë™ ê´€ë¦¬
    UI.message "ğŸ” ì¸ì¦ì„œ ë° í”„ë¡œë¹„ì €ë‹ í”„ë¡œí•„ ì„¤ì • ì¤‘..."
    cert(
      development: false,
      output_path: "./certs"
    )
    
    sigh(
      app_identifier: "com.cho407.CaptionMate",
      output_path: "./profiles"
    )
    
    # 3. ì•„ì¹´ì´ë¸Œ ë¹Œë“œ
    UI.message "ğŸ—ï¸ ì•„ì¹´ì´ë¸Œ ë¹Œë“œ ì¤‘..."
    build_app(
      scheme: "CaptionMate",
      export_method: "app-store",
      export_options: {
        method: "app-store",
        teamID: "H6P789M74Y"
      }
    )
    
    # 4. TestFlight ì—…ë¡œë“œ
    UI.message "ğŸ“¤ TestFlight ì—…ë¡œë“œ ì¤‘..."
    upload_to_testflight(
      ipa: lane_context[SharedValues::IPA_OUTPUT_PATH],
      skip_waiting_for_build_processing: true
    )
    
    UI.success "âœ… TestFlight ë°°í¬ ì™„ë£Œ!"
  end

  desc "Main ë¸Œëœì¹˜: ë¹Œë“œ + í…ŒìŠ¤íŠ¸ + ì•„ì¹´ì´ë¸Œë§Œ"
  lane :main_archive do
    UI.message "ğŸ“¦ Main ë¸Œëœì¹˜ ì•„ì¹´ì´ë¸Œ ì‹œì‘..."
    
    # 1. í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    UI.message "ğŸ“‹ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
    run_tests(
      scheme: "CaptionMate",
      device: "Any Mac"
    )
    
    # 2. ì½”ë“œ ì„œëª… ì—†ëŠ” ì•„ì¹´ì´ë¸Œ
    UI.message "ğŸ—ï¸ ì•„ì¹´ì´ë¸Œ ë¹Œë“œ ì¤‘..."
    build_app(
      scheme: "CaptionMate",
      export_method: "development",
      skip_codesigning: true
    )
    
    UI.success "âœ… ì•„ì¹´ì´ë¸Œ ìƒì„± ì™„ë£Œ!"
  end

  desc "ë¹Œë“œë§Œ ì‹¤í–‰ (í…ŒìŠ¤íŠ¸ ì œì™¸)"
  lane :build_only do
    UI.message "ğŸ—ï¸ ë¹Œë“œë§Œ ì‹¤í–‰ ì¤‘..."
    
    build_app(
      scheme: "CaptionMate",
      export_method: "development",
      skip_codesigning: true
    )
    
    UI.success "âœ… ë¹Œë“œ ì™„ë£Œ!"
  end

  desc "í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰"
  lane :test_only do
    UI.message "ğŸ“‹ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰ ì¤‘..."
    
    run_tests(
      scheme: "CaptionMate",
      device: "Any Mac"
    )
    
    UI.success "âœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"
  end
end
