# fastlane/Fastfile
opt_out_usage

# Fastlane report ìƒì„± ì™„ì „ ë¹„í™œì„±í™”
ENV["FL_OUTPUT_DIR"] = "/tmp/fastlane_output"
ENV["FL_TEST_OUTPUT_DIR"] = "/tmp/fastlane_test_output"
ENV["FL_SCAN_OUTPUT_DIRECTORY"] = "/tmp/fastlane_scan_output"
ENV["FL_GYM_OUTPUT_DIRECTORY"] = "/tmp/fastlane_gym_output"

default_platform(:mac)

platform :mac do
  desc "Develop ë¸Œëœì¹˜: ë¹Œë“œ + í…ŒìŠ¤íŠ¸ + TestFlight ë°°í¬"
  lane :develop_deploy do
    UI.message "ğŸš€ Develop ë¸Œëœì¹˜ ë°°í¬ ì‹œì‘..."

    # 1. ì¸ì¦ì„œ ë° í”„ë¡œë¹„ì €ë‹ í”„ë¡œí•„ ìë™ ê´€ë¦¬
    UI.message "ğŸ” ì¸ì¦ì„œ ë° í”„ë¡œë¹„ì €ë‹ í”„ë¡œí•„ ì„¤ì • ì¤‘..."
    cert(
      development: false,
      output_path: "./certs"
    )

    sigh(
      app_identifier: "com.cho407.CaptionMate",
      output_path: "./profiles"
    )

    # 2. í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ì¸ì¦ì„œ ì„¤ì • í›„)
    UI.message "ğŸ“‹ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
    run_tests(
      scheme: "CaptionMate",
      destination: "platform=macOS,arch=arm64",
      skip_slack: true,
      disable_concurrent_testing: true,
      open_report: false,
      output_directory: "/tmp/fastlane_test_results",
      output_types: "junit",
      skip_codesigning: true
    )

    # 3. ì•„ì¹´ì´ë¸Œ ë¹Œë“œ
    UI.message "ğŸ—ï¸ ì•„ì¹´ì´ë¸Œ ë¹Œë“œ ì¤‘..."
    build_app(
      scheme: "CaptionMate",
      export_method: "app-store",
      export_options: {
        method: "app-store",
        teamID: "H6P789M74Y"
      }
    )

    # 4. TestFlight ì—…ë¡œë“œ
    UI.message "ğŸ“¤ TestFlight ì—…ë¡œë“œ ì¤‘..."
    upload_to_testflight(
      ipa: lane_context[SharedValues::IPA_OUTPUT_PATH],
      skip_waiting_for_build_processing: true
    )

    UI.success "âœ… TestFlight ë°°í¬ ì™„ë£Œ!"
  end

  desc "Main ë¸Œëœì¹˜: ë¹Œë“œë§Œ ì‹¤í–‰ (ì•„ì¹´ì´ë¸Œ ë° export ì œì™¸)"
  lane :main_archive do
    UI.message "ğŸ“¦ Main ë¸Œëœì¹˜ ë¹Œë“œ ì‹œì‘..."

    # ì½”ë“œ ì„œëª… ì—†ëŠ” ë¹Œë“œë§Œ ì‹¤í–‰ (ì•„ì¹´ì´ë¸Œ ë° export ì—†ì´)
    UI.message "ğŸ—ï¸ ë¹Œë“œ ì‹¤í–‰ ì¤‘..."
    build_app(
      scheme: "CaptionMate",
      skip_codesigning: true,
      skip_archive: true,
      skip_package_ipa: true,
      skip_package_pkg: true
    )

    UI.success "âœ… ë¹Œë“œ ì™„ë£Œ! (ì•„ì¹´ì´ë¸Œ ë° export ë‹¨ê³„ ê±´ë„ˆëœ€)"
  end

  desc "ë¹Œë“œë§Œ ì‹¤í–‰ (í…ŒìŠ¤íŠ¸ ì œì™¸)"
  lane :build_only do
    UI.message "ğŸ—ï¸ ë¹Œë“œë§Œ ì‹¤í–‰ ì¤‘..."

    build_app(
      scheme: "CaptionMate",
      export_method: "development",
      skip_codesigning: true
    )

    UI.success "âœ… ë¹Œë“œ ì™„ë£Œ!"
  end

  desc "í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰"
  lane :test_only do
    UI.message "ğŸ“‹ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰ ì¤‘..."

    run_tests(
      scheme: "CaptionMate",
      destination: "platform=macOS,arch=arm64",
      skip_slack: true,
      disable_concurrent_testing: true,
      open_report: false,
      output_directory: "/tmp/fastlane_test_results",
      output_types: "junit",
      skip_codesigning: true
    )

    UI.success "âœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"
  end
end
