# fastlane/Fastfile
opt_out_usage

# Fastlane report 생성 완전 비활성화
ENV["FL_OUTPUT_DIR"] = "/tmp/fastlane_output"
ENV["FL_TEST_OUTPUT_DIR"] = "/tmp/fastlane_test_output"
ENV["FL_SCAN_OUTPUT_DIRECTORY"] = "/tmp/fastlane_scan_output"
ENV["FL_GYM_OUTPUT_DIRECTORY"] = "/tmp/fastlane_gym_output"

default_platform(:mac)

# Match 설정
MATCH_GIT_URL = ENV["MATCH_GIT_URL"] || "https://github.com/cho407/captionmate-certificates.git"
MATCH_PASSWORD = ENV["MATCH_PASSWORD"]

platform :mac do
  desc "Develop 브랜치: 빌드 + 테스트 + TestFlight 배포"
  lane :develop_deploy do
    UI.message "🚀 Develop 브랜치 배포 시작..."

    # 1. Fastlane Match로 인증서 및 프로비저닝 프로필 관리
    UI.message "🔐 Match를 통한 인증서 및 프로비저닝 프로필 설정 중..."
    match(
      type: "appstore",
      app_identifier: "com.cho407.CaptionMate",
      git_url: MATCH_GIT_URL,
      git_basic_authorization: ENV["MATCH_GIT_AUTH"],
      readonly: true,
      keychain_name: "login.keychain",
      keychain_password: ""
    )

    # 2. 테스트 실행 (인증서 설정 후)
    UI.message "📋 테스트 실행 중..."
    run_tests(
      scheme: "CaptionMate",
      destination: "platform=macOS,arch=arm64",
      skip_slack: true,
      disable_concurrent_testing: true,
      open_report: false,
      output_directory: "/tmp/fastlane_test_results",
      output_types: "junit",
      skip_codesigning: true
    )

    # 3. 아카이브 빌드
    UI.message "🏗️ 아카이브 빌드 중..."
    build_app(
      scheme: "CaptionMate",
      export_method: "app-store",
      export_options: {
        method: "app-store",
        teamID: "H6P789M74Y"
      }
    )

    # 4. TestFlight 업로드
    UI.message "📤 TestFlight 업로드 중..."
    upload_to_testflight(
      ipa: lane_context[SharedValues::IPA_OUTPUT_PATH],
      skip_waiting_for_build_processing: true
    )

    UI.success "✅ TestFlight 배포 완료!"
  end

  desc "Main 브랜치: 빌드만 실행 (아카이브 및 export 제외)"
  lane :main_archive do
    UI.message "📦 Main 브랜치 빌드 시작..."

    # 코드 서명 없는 빌드만 실행 (아카이브 및 export 없이)
    UI.message "🏗️ 빌드 실행 중..."
    build_app(
      scheme: "CaptionMate",
      skip_codesigning: true,
      skip_archive: true,
      skip_package_ipa: true,
      skip_package_pkg: true
    )

    UI.success "✅ 빌드 완료! (아카이브 및 export 단계 건너뜀)"
  end

  desc "빌드만 실행 (테스트 제외)"
  lane :build_only do
    UI.message "🏗️ 빌드만 실행 중..."

    build_app(
      scheme: "CaptionMate",
      export_method: "development",
      skip_codesigning: true
    )

    UI.success "✅ 빌드 완료!"
  end

  desc "테스트만 실행"
  lane :test_only do
    UI.message "📋 테스트만 실행 중..."

    run_tests(
      scheme: "CaptionMate",
      destination: "platform=macOS,arch=arm64",
      skip_slack: true,
      disable_concurrent_testing: true,
      open_report: false,
      output_directory: "/tmp/fastlane_test_results",
      output_types: "junit",
      skip_codesigning: true
    )

    UI.success "✅ 테스트 완료!"
  end

  desc "Match 초기화 (최초 1회만 실행)"
  lane :match_init do
    UI.message "🔧 Match 초기화 시작..."

    # Match 초기화
    match(
      type: "appstore",
      app_identifier: "com.cho407.CaptionMate",
      git_url: MATCH_GIT_URL,
      git_basic_authorization: ENV["MATCH_GIT_AUTH"],
      readonly: false,
      force_for_new_devices: true
    )

    UI.success "✅ Match 초기화 완료!"
  end

  desc "Match 인증서 갱신"
  lane :match_renew do
    UI.message "🔄 Match 인증서 갱신 시작..."

    match(
      type: "appstore",
      app_identifier: "com.cho407.CaptionMate",
      git_url: MATCH_GIT_URL,
      git_basic_authorization: ENV["MATCH_GIT_AUTH"],
      readonly: false,
      force_for_new_devices: true
    )

    UI.success "✅ Match 인증서 갱신 완료!"
  end
end
